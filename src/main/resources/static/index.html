<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>简易聊天应用</title>
    <!-- 引入 day.js 用于格式化日期 -->
    <script src="https://unpkg.com/dayjs"></script>
    <!-- 添加自定义的 CSS 样式 -->
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f2f2f2;
            margin: 0;
            padding: 0;
        }
        h1 {
            background-color: #4CAF50;
            color: white;
            margin: 0;
            padding: 20px;
            text-align: center;
        }
        #container {
            display: flex;
            max-width: 1200px;
            margin: 20px auto;
            padding: 10px;
        }
        /* 聊天区样式 */
        #chat {
            flex: 3;
            background-color: #fff;
            border: 2px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            margin-right: 20px;
            display: flex;
            flex-direction: column;
            height: 600px;
            position: relative;
        }
        /* 消息列表样式 */
        #messages {
            list-style-type: none;
            padding: 10px;
            margin: 0;
            max-height: 500px;
            overflow-y: auto;
            background-color: #fafafa;
            border: 1px solid #ccc;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
        }
        /* 消息项样式 */
        .message {
            margin-bottom: 10px;
            max-width: 70%;
            word-wrap: break-word;
        }
        /* 自己发送的消息靠右显示 */
        .message.sent {
            align-self: flex-end;
            text-align: right;
        }
        /* 他人发送的消息靠左显示 */
        .message.received {
            align-self: flex-start;
            text-align: left;
        }
        /* 私聊消息样式 */
        .message.private .message-content {
            background-color: #fff4e5;
            border: 1px solid #ffcc80;
            border-radius: 10px;
            padding: 10px;
        }
        /* 群聊消息样式 */
        .message.group .message-content {
            background-color: #e0f7fa;
            border: 1px solid #80deea;
            border-radius: 10px;
            padding: 10px;
        }
        /* 消息文本 */
        .message-text {
            font-size: 16px;
            margin-bottom: 5px;
        }
        /* 消息信息（发送者和时间） */
        .message-info {
            font-size: 12px;
            color: #666;
        }
        /* 聊天输入区域 */
        #inputArea {
            display: flex;
            margin-top: 10px;
        }
        #receiverSelect,
        #messageInput {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 14px;
            margin-right: 10px;
        }
        #receiverSelect {
            width: 200px;
        }
        #messageInput {
            flex: 1;
        }
        #sendButton {
            padding: 10px 20px;
            background-color: #4CAF50;
            border: none;
            border-radius: 3px;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
        }
        #sendButton:hover {
            background-color: #45a049;
        }
        /* 用户列表样式 */
        #userList {
            flex: 1;
            background-color: #fff;
            border: 2px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            height: 600px;
            overflow-y: auto;
        }
        #userList h3 {
            margin-top: 0;
            text-align: center;
            color: #333;
        }
        #userListItems {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        #userListItems li {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .status-icon {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-online {
            background-color: green;
        }
        .status-offline {
            background-color: gray;
        }
        /* 滚动条美化 */
        #messages::-webkit-scrollbar,
        #userList::-webkit-scrollbar {
            width: 8px;
        }
        #messages::-webkit-scrollbar-thumb,
        #userList::-webkit-scrollbar-thumb {
            background-color: #888;
            border-radius: 4px;
        }
        #messages::-webkit-scrollbar-thumb:hover,
        #userList::-webkit-scrollbar-thumb:hover {
            background-color: #555;
        }
        /* 登录界面样式 */
        #loginContainer {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            border: 2px solid #ccc;
            border-radius: 5px;
            background-color: #fff;
            display: none; /* 默认隐藏 */
        }
        #loginContainer.active {
            display: block; /* 显示登录界面 */
        }
        #loginForm div {
            margin-bottom: 15px;
        }
        #loginForm label {
            display: block;
            margin-bottom: 5px;
        }
        #loginForm input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        #loginForm button {
            width: 100%;
            padding: 10px;
            background-color: #4CAF50;
            border: none;
            border-radius: 3px;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
        }
        #loginForm button:hover {
            background-color: #45a049;
        }
        #registerContainer {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            border: 2px solid #ccc;
            border-radius: 5px;
            background-color: #fff;
            display: none; /* 默认隐藏 */
        }
        #registerContainer.active {
            display: block; /* 显示注册界面 */
        }
        /* 当前用户名显示样式 */
        #currentUsername {
            position: absolute;
            bottom: 10px;
            left: 10px;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
<h1>简易聊天应用</h1>

<!-- 登录界面 -->
<div id="loginContainer" class="active">
    <h2 style="text-align: center;">登录</h2>
    <form id="loginForm">
        <div>
            <label for="loginUsername">用户名：</label>
            <input type="text" id="loginUsername" name="username" required />
        </div>
        <div>
            <label for="loginPassword">密码：</label>
            <input type="password" id="loginPassword" name="password" required />
        </div>
        <button type="submit">登录</button>
    </form>
    <p style="text-align: center; margin-top: 10px;">
        没有账号？ <a href="#" id="showRegister">注册</a>
    </p>
</div>

<!-- 注册界面 -->
<div id="registerContainer">
    <h2 style="text-align: center;">注册</h2>
    <form id="registerForm">
        <div>
            <label for="registerUsername">用户名：</label>
            <input type="text" id="registerUsername" name="username" required />
        </div>
        <div>
            <label for="registerPassword">密码：</label>
            <input type="password" id="registerPassword" name="password" required />
        </div>
        <button type="submit">注册</button>
    </form>
    <p style="text-align: center; margin-top: 10px;">
        已有账号？ <a href="#" id="showLogin">登录</a>
    </p>
</div>

<!-- 聊天与用户列表区域，默认隐藏 -->
<div id="container" style="display: none;">
    <!-- 聊天区 -->
    <div id="chat">
        <ul id="messages"></ul>
        <!-- 输入区域 -->
        <div id="inputArea">
            <select id="receiverSelect">
                <option value="">选择接收者（可选）</option>
            </select>
            <input id="messageInput" type="text" placeholder="输入消息..." autofocus />
            <button id="sendButton">发送</button>
        </div>
        <!-- 当前用户名显示 -->
        <div id="currentUsername">当前用户: 未登录</div>
    </div>
    <!-- 用户列表 -->
    <div id="userList">
        <h3>用户列表</h3>
        <ul id="userListItems"></ul>
    </div>
</div>

<script>
    // 获取登录和注册相关元素
    var loginContainer = document.getElementById("loginContainer");
    var registerContainer = document.getElementById("registerContainer");
    var showRegister = document.getElementById("showRegister");
    var showLogin = document.getElementById("showLogin");
    var loginForm = document.getElementById("loginForm");
    var registerForm = document.getElementById("registerForm");
    var container = document.getElementById("container");

    var ws; // WebSocket 对象
    var username; // 当前登录的用户名

    // 切换到注册界面
    showRegister.addEventListener("click", function (event) {
        event.preventDefault();
        loginContainer.classList.remove("active");
        registerContainer.classList.add("active");
    });

    // 切换到登录界面
    showLogin.addEventListener("click", function (event) {
        event.preventDefault();
        registerContainer.classList.remove("active");
        loginContainer.classList.add("active");
    });

    // 处理登录表单提交
    loginForm.addEventListener("submit", function (event) {
        event.preventDefault();
        var loginUsername = document.getElementById("loginUsername").value.trim();
        var loginPassword = document.getElementById("loginPassword").value.trim();

        if (!loginUsername || !loginPassword) {
            alert("用户名和密码不能为空！");
            return;
        }

        // 建立 WebSocket 连接
        ws = new WebSocket("ws://localhost:8081/chat");

        ws.onopen = function () {
            console.log("WebSocket 连接已打开");
            // 连接建立后，发送登录消息
            var loginMessage = {
                type: "login",
                username: loginUsername,
                password: loginPassword
            };
            ws.send(JSON.stringify(loginMessage));
        };

        ws.onmessage = function (event) {
            console.log("Received data:", event.data); // 调试日志
            var data;
            try {
                data = JSON.parse(event.data);
            } catch (e) {
                console.error("JSON 解析错误:", e);
                return;
            }

            if (data.type === "login") {
                handleLoginResponse(data);
            } else if (data.type === "register") {
                handleRegisterResponse(data);
            } else if (data.type === "message") {
                displayMessage(data);
            } else if (data.type === "userList") {
                updateUserList(data.users);
            } else if (data.type === "userStatusUpdate") {
                updateUserStatus(data.users);
            } else if (data.type === "error") {
                alert("错误：" + data.message);
            } else if (data.type === "history") {
                loadChatHistory(data.messages);
            }
        };

        ws.onclose = function () {
            console.log("WebSocket 连接已关闭");
            alert("WebSocket 连接已关闭。");
            // 重置界面
            container.style.display = "none";
            loginContainer.classList.add("active");
            document.getElementById("currentUsername").textContent = "当前用户: 未登录";
        };

        ws.onerror = function (error) {
            console.error("WebSocket 错误：", error);
            alert("WebSocket 连接错误。");
        };
    });

    // 处理注册表单提交
    registerForm.addEventListener("submit", function (event) {
        event.preventDefault();
        var registerUsername = document.getElementById("registerUsername").value.trim();
        var registerPassword = document.getElementById("registerPassword").value.trim();

        if (!registerUsername || !registerPassword) {
            alert("用户名和密码不能为空！");
            return;
        }

        // 建立 WebSocket 连接
        ws = new WebSocket("ws://localhost:8081/chat");

        ws.onopen = function () {
            console.log("WebSocket 连接已打开");
            // 连接建立后，发送注册消息
            var registerMessage = {
                type: "register",
                username: registerUsername,
                password: registerPassword
            };
            ws.send(JSON.stringify(registerMessage));
        };

        ws.onmessage = function (event) {
            console.log("Received data:", event.data); // 调试日志
            var data;
            try {
                data = JSON.parse(event.data);
            } catch (e) {
                console.error("JSON 解析错误:", e);
                return;
            }

            if (data.type === "register") {
                handleRegisterResponse(data);
            } else if (data.type === "userList") {
                updateUserList(data.users);
            } else if (data.type === "userStatusUpdate") {
                updateUserStatus(data.users);
            } else if (data.type === "error") {
                alert("错误：" + data.message);
            }
        };

        ws.onclose = function () {
            console.log("WebSocket 连接已关闭");
            alert("WebSocket 连接已关闭。");
            // 重置界面
            registerContainer.classList.remove("active");
            loginContainer.classList.add("active");
        };

        ws.onerror = function (error) {
            console.error("WebSocket 错误：", error);
            alert("WebSocket 连接错误。");
        };
    });

    // 发送消息
    var sendButton = document.getElementById("sendButton");
    var messageInput = document.getElementById("messageInput");
    var receiverSelect = document.getElementById("receiverSelect");

    sendButton.addEventListener("click", function () {
        var content = messageInput.value.trim();
        var receiverValue = receiverSelect.value;
        var receiver = receiverValue ? receiverValue : null; // 如果没有选择接收者，设置为 null

        if (content) {
            var message = {
                type: "message",
                content: content,
                sender: username,
                receiver: receiver,
                timestamp: new Date().getTime() // 使用当前时间的时间戳
            };

            ws.send(JSON.stringify(message));
            messageInput.value = "";
        }
    });

    // 按下回车键发送消息
    messageInput.addEventListener("keypress", function (event) {
        if (event.key === "Enter") {
            sendButton.click();
        }
    });

    /**
     * 处理登录响应
     */
    function handleLoginResponse(data) {
        if (data.status === "success") {
            console.log("登录成功！");
            loginContainer.classList.remove("active");
            container.style.display = "flex";
            username = document.getElementById("loginUsername").value.trim(); // 设置为全局变量
            // 更新当前用户名显示
            document.getElementById("currentUsername").textContent = "当前用户: " + username;
        } else {
            alert("登录失败：" + data.message);
            ws.close();
        }
    }

    /**
     * 处理注册响应
     */
    function handleRegisterResponse(data) {
        if (data.status === "success") {
            alert("注册成功，请登录！");
            registerContainer.classList.remove("active");
            loginContainer.classList.add("active");
        } else {
            alert("注册失败：" + data.message);
        }
    }

    /**
     * 显示消息
     */
    function displayMessage(data) {
        console.log("Display message:", data); // 调试日志
        var messagesList = document.getElementById("messages");
        var newMessage = document.createElement("div"); // 使用 div 而非 li
        var sender = data.sender;
        var content = data.content;
        var receiver = data.receiver;
        var timestamp = data.timestamp; // 获取时间戳

        // 检查 timestamp 是否有效
        if (typeof timestamp !== 'number' || isNaN(timestamp)) {
            console.error("Invalid timestamp:", timestamp);
            return;
        }

        // 将时间戳转换为日期对象
        var date = dayjs(timestamp);
        console.log("Parsed date:", date.format('YYYY-MM-DD HH:mm')); // 调试日志

        // 格式化日期时间字符串，例如 "2024-11-06 09:00"
        var formattedTime = date.format('YYYY-MM-DD HH:mm');

        var messageHtml = "";

        if (receiver && (receiver === username || sender === username)) {
            // 私聊消息
            if (sender === username) {
                // 自己发送的私聊消息
                newMessage.className = "message private sent";
                messageHtml = `<div class="message-content">
                    <div class="message-text">${content}</div>
                    <div class="message-info">你悄悄对 <strong>${receiver}</strong> 说 • ${formattedTime}</div>
                </div>`;
            } else {
                // 别人发送给你的私聊消息
                newMessage.className = "message private received";
                messageHtml = `<div class="message-content">
                    <div class="message-text">${content}</div>
                    <div class="message-info"><strong>${sender}</strong> 悄悄对你说 • ${formattedTime}</div>
                </div>`;
            }
        } else {
            if (sender === username) {
                // 自己发送的群聊消息
                newMessage.className = "message group sent";
                messageHtml = `<div class="message-content">
                    <div class="message-text">${content}</div>
                    <div class="message-info">你 • ${formattedTime}</div>
                </div>`;
            } else {
                // 别人发送的群聊消息
                newMessage.className = "message group received";
                messageHtml = `<div class="message-content">
                    <div class="message-text">${content}</div>
                    <div class="message-info"><strong>${sender}</strong> • ${formattedTime}</div>
                </div>`;
            }
        }
        newMessage.innerHTML = messageHtml;
        messagesList.appendChild(newMessage);
        // 滚动到底部
        messagesList.scrollTop = messagesList.scrollHeight;
    }

    /**
     * 更新用户列表显示
     * @param {Object} users - 用户名与状态的映射
     */
    function updateUserList(users) {
        console.log("Updating user list with users:", users); // 调试日志
        var userList = document.getElementById("userListItems");
        userList.innerHTML = ""; // 清空当前列表

        for (var user in users) {
            if (user === username) continue; // 不显示自己

            var status = users[user];

            var userItem = document.createElement("li");

            // 创建状态图标
            var statusIcon = document.createElement("span");
            statusIcon.classList.add("status-icon");
            if (status === "online") {
                statusIcon.classList.add("status-online");
            } else {
                statusIcon.classList.add("status-offline");
            }

            userItem.appendChild(statusIcon);

            // 用户名文本
            var userNameText = document.createElement("span");
            userNameText.textContent = user;
            userItem.appendChild(userNameText);

            // 添加点击事件，点击用户名自动选择接收者
            userNameText.addEventListener("click", function () {
                receiverSelect.value = this.textContent;
                console.log("Selected receiver:", this.textContent); // 调试日志
            });

            userList.appendChild(userItem);
        }

        // 更新接收者下拉框
        populateReceiverSelect(users);
    }

    /**
     * 更新所有用户的状态
     * @param {Object} users - 用户名与状态的映射
     */
    function updateUserStatus(users) {
        console.log("Updating user status with users:", users); // 调试日志
        // 直接调用 updateUserList，因为 userStatusUpdate 包含完整用户列表
        updateUserList(users);
    }

    /**
     * 填充接收者下拉框
     * @param {Object} users - 用户名与状态的映射
     */
    function populateReceiverSelect(users) {
        var receiverSelect = document.getElementById("receiverSelect");
        receiverSelect.innerHTML = '<option value="">选择接收者（可选）</option>'; // 重置选项

        for (var user in users) {
            if (user === username) continue; // 不显示自己

            var status = users[user];

            var option = document.createElement("option");
            option.value = user;
            // 显示用户名及其在线状态
            option.textContent = user + (status === "online" ? " (在线)" : " (离线)");
            receiverSelect.appendChild(option);
        }
    }

    /**
     * 加载聊天历史
     * @param {Array} messages - 聊天消息数组
     */
    function loadChatHistory(messages) {
        console.log("Loading chat history:", messages); // 调试日志
        var messagesList = document.getElementById("messages");
        messagesList.innerHTML = ""; // 清空当前消息列表

        messages.forEach(function (message) {
            displayMessage(message);
        });
    }
</script>
</body>
</html>
